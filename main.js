(()=>{"use strict";const e=class{constructor(e,t){this._formSelector=e.formSelector,this._inputSelector=e.inputSelector,this._submitButtonSelector=e.submitButtonSelector,this._inactiveButtonClass=e.inactiveButtonClass,this._inputErrorClass=e.inputErrorClass,this._errorClass=e.errorClass,this._formElement=t}_showError=(e,t)=>{const r=this._formElement.querySelector(`.${e.id}-error`);e.classList.add(this._inputErrorClass),r.textContent=t,r.classList.add(this._errorClass)};_hideError=e=>{const t=this._formElement.querySelector(`.${e.id}-error`);e.classList.remove(this._inputErrorClass),t.classList.remove(this._errorClass),t.textContent=""};_checkInputValidity=e=>{e.validity.valid?this._hideError(e):this._showError(e,e.validationMessage)};_setEventListeners=(e,t)=>{this._toggleButtonState(t,e),t.forEach((r=>{r.addEventListener("input",(()=>{this._checkInputValidity(r),this._toggleButtonState(t,e)}))}))};_toggleButtonState=(e,t)=>{this._hasInvalidInput(e)?this._disableSubmitButton(t):(t.classList.remove(this._inactiveButtonClass),t.removeAttribute("disabled"))};_disableSubmitButton=e=>{e.classList.add(this._inactiveButtonClass),e.setAttribute("disabled",!0)};enableValidation=()=>{const e=Array.from(this._formElement.querySelectorAll(this._inputSelector)),t=this._formElement.querySelector(this._submitButtonSelector);this._formElement.addEventListener("submit",(e=>{e.preventDefault(),this._disableSubmitButton(t)})),this._setEventListeners(t,e)};_hasInvalidInput(e){return e.some((e=>!e.validity.valid))}},t=document.querySelector(".popup-profile"),r=document.querySelector(".button_type_edit"),o=t.querySelector(".popup__form-profile"),s=document.querySelector(".profile__info-name"),i=document.querySelector(".profile__info-activity"),n=document.querySelector(".popup__form-text_type_name"),l=document.querySelector(".popup__form-text_type_activity"),a=document.querySelector(".profile__avatar"),c=document.querySelector(".popup-avatar-change"),u=document.querySelector(".popup-confirm-delete"),h=document.querySelector(".popup-place"),_=document.querySelector(".button_type_add"),d=h.querySelector(".popup__form-place"),p=(d.querySelector(".popup__form-text_type_name-pic"),d.querySelector(".popup__form-text_type_link"),Array.from(document.querySelectorAll(".popup")),document.querySelector(".elements__list")),m=document.querySelector(".popup-card"),S=m.querySelector(".popup-card__pic"),v=m.querySelector(".popup-card__picname"),y=(document.querySelector(".card__like-count"),document.querySelector(".button_type_delete"),document.querySelector(".popup__form-edit-avatar-picture")),f={formSelector:".popup__form",inputSelector:".popup__form-text",submitButtonSelector:".button_type_save",inactiveButtonClass:"button_type_invalid",inputErrorClass:"popup__form-text-error",errorClass:"popup__form-text-error_active"},k=document.querySelectorAll(f.submitButtonSelector),b=class{constructor(e){this._popupSelector=e}open(){this._popupSelector.classList.add("element_visible"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popupSelector.classList.remove("element_visible"),document.removeEventListener("keydown",this._handleEscClose)}_handleEscClose=e=>{"Escape"===e.key&&this._popupSelector.classList.contains("element_visible")&&this.close()};setEventListeners(){this._popupSelector.querySelector(".popup__overlay").addEventListener("click",(()=>{this.close()})),this._popupSelector.querySelector(".button_type_close").addEventListener("click",(()=>{this.close()}))}},C=class extends b{constructor({handleFormSubmit:e},t){super(t),this.popupSelector=t,this._handleFormSubmit=e}_getInputValues(){return this._inputList=this.popupSelector.querySelectorAll(".popup__form-text"),this._formValues={},this._inputList.forEach((e=>this._formValues[e.name]=e.value)),this._formValues}setEventListeners(){super.setEventListeners(),this.popupSelector.querySelector(f.formSelector).addEventListener("submit",(e=>{e.preventDefault(),this._handleFormSubmit(this._getInputValues())}))}close(){super.close(),this.popupSelector.querySelector(f.formSelector).reset()}},L=class extends b{constructor(e){super(e)}setSubmitAction(e){this.callbackSubmitAction=e}setEventListeners(){super.setEventListeners(),this._popupSelector.querySelector(".button_type_submit").addEventListener("click",(()=>this.callbackSubmitAction()))}},E=new e(f,o),q=new e(f,d),g=new e(f,y),I=new class extends b{constructor(e){super(e)}open(e){super.open(),S.src=e.link,S.alt=e.name,v.textContent=e.name}}(m);let w=[],A=null;I.setEventListeners();const x=new class{constructor(e){this._url=e.url,this._authorization=e.authorization}_handleResponse=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`);getCards(){return fetch(`${this._url}/cards`,{method:"GET",headers:{authorization:this._authorization}}).then(this._handleResponse).catch((e=>{console.log(e)}))}getUserInformation(){return fetch(`${this._url}/users/me`,{method:"GET",headers:{authorization:this._authorization}}).then(this._handleResponse).catch((e=>{console.log(e)}))}setUserAvatar(e){return fetch(`${this._url}/users/me/avatar`,{method:"PATCH",headers:{authorization:this._authorization,"Content-Type":"application/json"},body:JSON.stringify({avatar:e.link})}).then(this._handleResponse).catch((e=>{console.log(e)}))}setUserInfo(e){return fetch(`${this._url}/users/me`,{method:"PATCH",headers:{authorization:this._authorization,"Content-Type":"application/json"},body:JSON.stringify({name:e.name,about:e.about})}).then(this._handleResponse).catch((e=>{console.log(e)}))}setLikeOnCard(e){return fetch(`${this._url}/cards/likes/${e}`,{method:"PUT",headers:{authorization:this._authorization}}).then(this._handleResponse).catch((e=>{console.log(e)}))}removeLikeOnCard(e){return fetch(`${this._url}/cards/likes/${e}`,{method:"DELETE",headers:{authorization:this._authorization}}).then(this._handleResponse).catch((e=>{console.log(e)}))}addCards(e,t){return fetch(`${this._url}/cards`,{method:"POST",headers:{authorization:this._authorization,"Content-Type":"application/json"},body:JSON.stringify({name:e,link:t})}).then(this._handleResponse).catch((e=>{console.log(e)}))}deleteCard(e){return fetch(`${this._url}/cards/${e._id}`,{method:"DELETE",headers:{authorization:this._authorization,"Content-Type":"application/json"}}).then(this._handleResponse).catch((e=>{console.log(e)}))}}({url:"https://mesto.nomoreparties.co/v1/cohort-27",authorization:"a3d0e919-8de7-4208-b834-e803f8c056f2"}),B=e=>{e?k.forEach((e=>{e.textContent="Сохранение..."})):k.forEach((e=>{e.textContent="Сохранить"}))};E.enableValidation(),q.enableValidation(),g.enableValidation(),Promise.all([x.getUserInformation(),x.getCards()]).then((([e,o])=>{const d=new class{constructor({data:e}){this._profileNameSelector=e.name,this._profileActivitySelector=e.about,this._profilePictureSelector=e.avatar,this._profileId=e._id}getUserInfo=()=>{n.value=this._profileNameSelector,l.value=this._profileActivitySelector};getUserInfoFromServer=()=>{s.textContent=this._profileNameSelector,i.textContent=this._profileActivitySelector};getUserAvatarFromServer=()=>{a.src=this._profilePictureSelector};setAvatar=e=>{a.src=e.link};setUserInfo=()=>{this._profileNameSelector=n.value,this._profileActivitySelector=l.value};ableSubmitButtonOpeningPopupProfile=()=>{const e=t.querySelector(f.submitButtonSelector);e.classList.remove(f.inactiveButtonClass),e.removeAttribute("disabled")}}({data:e});d.getUserInfoFromServer(),d.getUserAvatarFromServer();const m=new C({handleFormSubmit:e=>{B(!0),x.setUserInfo(e).then((()=>{d.setUserInfo(),d.getUserInfoFromServer()})).then((()=>{m.close()})).finally((()=>{B(!1)}))}},t);m.setEventListeners(),r.addEventListener("click",(()=>{m.open(),d.getUserInfo(),d.ableSubmitButtonOpeningPopupProfile()}));const S=new L(u);S.setEventListeners();const v=(t,r)=>{const o=new class{constructor({item:e,cardSelector:t,handleCardClick:r,handleLikeClick:o,handleDeleteCard:s}){this._name=e.name,this._link=e.link,this._cardSelector=t,this._handleCardClick=r,this._handleLikeClick=o,this._handleDeleteCard=s}_getTemplate(){return document.querySelector(this._cardSelector).content.querySelector(".card").cloneNode(!0)}generateCard(){this._element=this._getTemplate();const e=this._element.querySelector(".card__name"),t=this._element.querySelector(".card__pic");return e.textContent=this._name,t.src=this._link,t.alt=this._name,this._setEventListeners(),this._element}getLike(e,t){this._isLiked=t.likes.filter((t=>t._id==e._id)).length>0,this._isLiked?this._element.querySelector(".button_type_like").classList.add("button_type_like-active"):this._element.querySelector(".button_type_like").classList.remove("button_type_like-active")}removeLike(){this._element.querySelector(".button_type_like").classList.remove("button_type_like-active")}activeLike(){this._element.querySelector(".button_type_like").classList.add("button_type_like-active")}showTrashIcon(e,t){e._id!=t.owner&&e._id!=t.owner._id||this._element.querySelector(".button_type_delete").classList.add("element_visible")}_setEventListeners(){this._element.querySelector(".card__pic").addEventListener("click",(()=>{this._handleCardClick()})),this._element.querySelector(".button_type_delete").addEventListener("click",(()=>{this._handleDeleteCard()})),this._element.querySelector(".button_type_like").addEventListener("click",(()=>{this._element.querySelector(".button_type_like").classList.contains("button_type_like-active")?this._handleLikeClick(!0):this._handleLikeClick(!1)}))}showLikeCountFromServer=e=>{this._element.querySelector(".card__like-count").textContent=e.length};deleteCardItem(e){e.remove(),e=null}}({item:t,cardSelector:".elements__list-template",handleCardClick:()=>{I.open(t)},handleLikeClick:e=>{!0===e?x.removeLikeOnCard(r._id).then((e=>o.showLikeCountFromServer(e.likes))).then((()=>o.removeLike())):!1===e&&x.setLikeOnCard(r._id).then((e=>o.showLikeCountFromServer(e.likes))).then((()=>o.activeLike()))},handleDeleteCard:()=>{S.open(),S.setSubmitAction((()=>{x.deleteCard(r).then((()=>{S.close(),o.deleteCardItem(s)}))}))}}),s=o.generateCard();A.addItem(s),o.showTrashIcon(e,r),o.getLike(e,r),o.showLikeCountFromServer(r.likes)},y=new C({handleFormSubmit:e=>{B(!0),x.setUserAvatar(e).then((()=>{d.setAvatar(e)})).then((()=>{y.close()})).finally((()=>{B(!1)}))}},c);y.setEventListeners(),a.addEventListener("click",(()=>{y.open()}));const k=new C({handleFormSubmit:e=>{B(!0),x.addCards(e.name,e.link).then((t=>{v(e,t)})).then((()=>{k.close()})).finally((()=>{B(!1)}))}},h);k.setEventListeners(),_.addEventListener("click",(()=>{k.open()})),w=o.map((e=>({name:e.name,link:e.link,likes:e.likes,owner:e.owner._id,_id:e._id}))),A=new class{constructor({items:e,renderer:t},r){this._renderedItems=e,this._renderer=t,this._container=r}addItem=e=>{this._container.prepend(e)};renderItems=()=>{this._renderedItems.forEach((e=>{this._renderer(e)}))}}({items:w,renderer:e=>{v(e,e)}},p),A.renderItems()}))})();